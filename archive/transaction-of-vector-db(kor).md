# Transaction of VectorDB

## ACID란?
- Atomicity (원자성): 트랜잭션이 데이터베이스에 모두 반영되거나 전혀 반영되지 않도록 보장합니다. 예를 들어, 벡터 데이터의 삽입 과정 중 에러가 발생하면, 이미 진행된 변경사항을 롤백합니다.
- Consistency (일관성): 트랜잭션이 성공적으로 완료된 후 데이터베이스가 일관된 상태를 유지하도록 합니다. 이는 벡터 데이터와 관련된 모든 제약 조건, 트리거 등이 트랜잭션 후에도 만족되어야 함을 의미합니다.
- Isolation (격리성): 동시에 실행되는 트랜잭션이 서로 영향을 주지 않도록 합니다. 이를 통해, 벡터 검색이나 업데이트 과정에서 동시에 발생하는 데이터 변경이 다른 트랜잭션에 부정적인 영향을 주지 않도록 관리할 수 있습니다.
- Durability (영속성): 성공적으로 완료된 트랜잭션의 결과는 시스템의 장애가 발생하더라도 손실되지 않습니다. 이는 벡터 데이터베이스도 장애 발생 후 데이터의 안정성을 보장할 수 있음을 의미합니다.

## 일반적으로 원자성을 달성하기 위한 방법
- 트랜잭션 로깅: 데이터베이스는 트랜잭션을 시작하기 전에 변경 사항을 로그로 기록합니다. 오류가 발생하면 이 로그를 사용하여 트랜잭션 이전 상태로 데이터를 롤백합니다. 이 방법은 데이터의 일관성을 유지하며, 작업이 완전히 성공하거나 실패하도록 보장합니다.
- 분산 시스템에서의 합의 알고리즘: 매니지드 서비스인 Pinecone 같은 시스템은 일반적으로 여러 노드에 걸쳐 데이터를 관리합니다. 이 경우, 합의 알고리즘(예: Paxos, Raft)을 사용하여 모든 노드가 트랜잭션의 실행에 대해 합의에 도달하도록 합니다. 이는 모든 변경 사항이 모든 노드에 일관되게 적용되도록 보장합니다.
- 데이터 파티셔닝 및 잠금 메커니즘: 데이터베이스는 트랜잭션이 진행되는 동안 관련 데이터 세트에 대한 접근을 제어하기 위해 잠금 메커니즘을 사용할 수 있습니다. 이는 동시에 발생하는 다른 트랜잭션이 데이터의 일관성을 깨뜨리는 것을 방지합니다.
- 원자적 연산 지원: 일부 시스템은 데이터베이스 엔진 레벨에서 원자적 연산을 지원합니다. 이는 개별 연산이나 작은 단위의 작업이 완전히 실행되거나 전혀 실행되지 않도록 보장합니다.

## 일반적으로 일관성을 달성하기 위한 방법
- 즉각적인 데이터 복제: 분산 시스템에서 데이터의 변경 사항을 모든 노드에 즉각적으로 복제함으로써, 어느 노드를 통해 데이터에 접근하더라도 항상 최신 상태의 데이터를 조회할 수 있도록 합니다. 이 과정에서는 네트워크 지연이 최소화되도록 최적화됩니다.
- 합의 프로토콜 사용: Paxos나 Raft와 같은 합의 알고리즘을 사용하여 모든 노드가 데이터 변경 사항에 대해 일관된 합의에 도달하도록 합니다. 이를 통해 모든 사용자가 데이터베이스의 최신 상태를 보게 됩니다.
- 글로벌 록 또는 잠금 메커니즘: 데이터를 변경하는 동안 전체 데이터베이스 또는 관련 데이터 세트에 대해 글로벌 록을 사용하여 동시 변경을 방지합니다. 이 방법은 데이터의 일관성을 유지하지만, 성능 저하의 원인이 될 수도 있습니다.
- 버전 관리 및 타임스탬프: 모든 데이터 변경 사항에 버전 번호나 타임스탬프를 부여하여, 사용자가 항상 가장 최신의 데이터를 조회할 수 있도록 합니다. 이는 변경 사항을 추적하고, 충돌을 해결하는 데 도움이 됩니다.

## 일반적으로 격리성을 달성하기 위한 방법
### 다중 버전 동시성 제어 (MVCC)
- MVCC (Multi-Version Concurrency Control): MVCC는 데이터의 여러 버전을 유지하여, 읽기 트랜잭션이 쓰기 트랜잭션에 의해 차단되지 않도록 합니다. 이 방법은 트랜잭션 시점에서 데이터의 특정 스냅샷을 읽어, 격리성을 유지하면서 동시성을 향상시킵니다.
### 잠금 메커니즘
- 잠금(Locking): 데이터 또는 데이터베이스의 특정 부분에 대해 트랜잭션에서 잠금을 설정하여, 해당 부분이 트랜잭션에 의해 독점적으로 사용될 수 있도록 합니다. 잠금은 다른 트랜잭션이 동시에 해당 데이터를 수정하는 것을 방지합니다.
### 최적화된 잠금 전략
- 낙관적(Optimistic) 및 비관적(Pessimistic) 잠금: 낙관적 잠금은 트랜잭션이 충돌을 일으킬 것으로 예상하지 않고 실행되며, 오직 커밋 시에만 데이터 충돌을 검사합니다. 비관적 잠금은 트랜잭션이 데이터에 접근하기 전에 잠금을 얻어, 충돌을 미연에 방지합니다.
### 격리 수준
- 격리 수준(Isolation Levels): 데이터베이스는 다양한 격리 수준을 제공하여, 어플리케이션이 필요에 따라 격리의 정도를 선택할 수 있게 합니다. 이는 성능과 일관성 사이의 균형을 맞추는 데 도움이 됩니다.

## 일반적으로 내구성을 달성하기 위한 방법
### 데이터 복제
- 데이터 복제(Replication): 데이터의 복사본을 여러 노드에 저장함으로써, 하나의 노드가 실패하더라도 다른 노드에서 데이터를 복구할 수 있습니다. Elasticsearch, Solr, Milvus는 분산 아키텍처를 기반으로 하여 데이터 복제를 통해 내구성을 강화합니다. Pinecone 역시 클라우드 기반 서비스로서 데이터 복제를 활용할 가능성이 높습니다.
### 영속성 보장
- 영속성(Persistence): 메모리 내 데이터뿐만 아니라 디스크에도 데이터를 저장하여, 시스템 재시작 후에도 데이터를 유지할 수 있습니다. 대부분의 벡터 데이터베이스 시스템들은 디스크 기반의 저장 솔루션을 사용하여 데이터의 영속성을 보장합니다.
### 트랜잭션 로그
- 트랜잭션 로깅(Transaction Logging): 모든 데이터 변경 사항은 트랜잭션 로그에 기록되며, 이를 통해 시스템 오류 발생 시 마지막으로 커밋된 상태로 데이터를 복구할 수 있습니다. 이 로그는 데이터의 내구성을 강화하는 데 중요한 역할을 합니다.
### 자동 복구 메커니즘
- 자동 복구(Automatic Recovery): 시스템이 비정상적으로 종료되었을 경우, 시작 시 자동 복구 프로세스를 통해 데이터의 일관성을 검사하고 복구합니다. 이는 트랜잭션 로그와 영속성 데이터를 사용하여 진행됩니다.
### 정기적인 백업
- 백업(Backup): 데이터를 주기적으로 백업하여, 큰 규모의 데이터 손실 사고가 발생했을 때 이를 복구할 수 있는 마지막 수단을 제공합니다. 백업은 외부 스토리지에 보관될 수 있으며, 필요 시 복구 작업에 사용됩니다.

## 각 VectorDB별 비교
|속성/VectorDB|Pinecone|Elasticsearch|Solr|Milvus|
|---|---|---|---|---|
| Atomicity (원자성) | 지원 |부분적으로 지원|부분적으로 지원|부분적으로 지원|
| Consistency (일관성)|강력한 일관성 지원|부분적으로 지원; 엄격한 일관성은 없음|부분적으로 지원; 엄격한 일관성은 없음|부분적으로 지원; 일관성 모델에 따라 다름|
| Isolation (고립성)|지원|부분적으로 지원|부분적으로 지원|부분적으로 지원|
| Durability (내구성)|지원|지원|지원|지원|

### 각 VectorDB별 트랜잭션 달성 방법
Pinecone: 클라우드 기반의 관리형 서비스로서, 자동화된 데이터 복제 및 분산 처리를 통해 트랜잭션의 견고성과 내구성을 보장합니다.
Elasticsearch: 데이터 변경 작업을 잘 정의된 RESTful API를 통해 수행하며, 내부적으로 영속성 및 복제 메커니즘을 사용하여 트랜잭션 유사한 작업을 지원합니다.
Solr: 다중 버전 동시성 제어(MVCC) 및 쓰기 앞 로그(write-ahead log)를 사용하여 변경 사항의 영속성을 보장하고, 트랜잭션 유사한 환경을 제공합니다.
Milvus: 분산 시스템 설계와 함께 WAL(Write-Ahead Logging)을 통해 데이터의 영속성과 복구를 지원하며, 이를 통해 트랜잭션의 내구성을 강화합니다.

## 참고 URL
- https://www.linkedin.com/pulse/choosing-vector-database-your-gen-ai-stack-abhinav-srivastava/
- https://mingchin.tistory.com/381
- https://inspirit941.tistory.com/504
